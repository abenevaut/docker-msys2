name: release

on:
  push:
    tags:
      - docker-*

env:
  windows_version: 10

jobs:

  build:
    runs-on: windows-2019
    steps:

      - uses: actions/checkout@v1

      - name: Get current release tag
        id: branch-name
        run: |
          $tag = $env:GITHUB_REF -replace "refs/tags/docker-", ""
          echo "SOURCE_TAG=$tag" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Build docker image abenevaut/msys2
        run: |
          docker login -u ${{ secrets.ABENEVAUT_DOCKER_USERNAME }} -p ${{ secrets.ABENEVAUT_DOCKER_PASSWORD }}
          docker pull abenevaut/msys2:latest-windows${{ env.windows_version }}
          docker build . --file Dockerfile --tag abenevaut/msys2:${{ steps.branch-name.outputs.SOURCE_TAG }}-windows${{ env.windows_version }} --cache-from abenevaut/msys2:latest-windows${{ env.windows_version }}
          docker tag abenevaut/msys2:${{ steps.branch-name.outputs.SOURCE_TAG }}-windows${{ env.windows_version }} abenevaut/msys2:latest-windows${{ env.windows_version }}
          docker push --all-tags abenevaut/msys2
